var U=Object.defineProperty;var s=(e,t)=>U(e,"name",{value:t,configurable:!0});function D(e,t){let n=new Request(e,t);return n.headers.delete("CF-Connecting-IP"),n}s(D,"stripCfConnectingIPHeader");globalThis.fetch=new Proxy(globalThis.fetch,{apply(e,t,n){return Reflect.apply(e,t,[D.apply(null,n)])}});function M(e=8){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",n=new Uint8Array(e);crypto.getRandomValues(n);let r="";for(let o=0;o<e;o++)r+=t[n[o]%t.length];return r}s(M,"generateShortCode");function b(e){let t=e.trim();return t.match(/^https?:\/\//i)?t:`https://${t}`}s(b,"normalizeUrl");function I(e){try{let t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}s(I,"isValidUrl");var _={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type","Access-Control-Max-Age":"86400"};function L(){return new Response(null,{status:204,headers:_})}s(L,"handleCorsPreflight");function c(e){let t=new Response(e.body,e);return Object.entries(_).forEach(([n,r])=>{t.headers.set(n,r)}),t}s(c,"addCorsHeaders");async function N(e,t){let n=e.ANALYTICS_WORKER_URL;if(n)try{await fetch(`${n}/analytics/redirect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch{}}s(N,"sendAnalyticsEvent");function O(e){return!e||typeof e!="string"?!1:/^[A-Za-z0-9_-]{8}$/.test(e)}s(O,"isValidProposedCode");async function P(e,t){try{let n=await e.json(),{longUrl:r,proposedCode:o}=n;if(!r||typeof r!="string")return c(new Response(JSON.stringify({error:"Missing or invalid longUrl"}),{status:400,headers:{"Content-Type":"application/json"}}));let i=b(r);if(!I(i))return c(new Response(JSON.stringify({error:"Invalid URL format"}),{status:400,headers:{"Content-Type":"application/json"}}));let a;if(O(o)&&(await t.KV_URLS.get(o)||(a=o)),!a){let f=0,w=10;do{if(a=M(),!await t.KV_URLS.get(a))break;f++}while(f<w);if(f>=w)return c(new Response(JSON.stringify({error:"Failed to generate unique code"}),{status:500,headers:{"Content-Type":"application/json"}}))}await t.KV_URLS.put(a,i);let m={shortUrl:`${new URL(e.url).origin}/${a}`,longUrl:i};return c(new Response(JSON.stringify(m),{status:200,headers:{"Content-Type":"application/json"}}))}catch{return c(new Response(JSON.stringify({error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json"}}))}}s(P,"handleShorten");async function v(e,t,n,r){let o=Date.now(),i=await t.KV_URLS.get(r);if(!i)return c(new Response(JSON.stringify({error:"Short URL not found"}),{status:404,headers:{"Content-Type":"application/json"}}));let a=Date.now()-o;return n.waitUntil(N(t,{code:r,longUrl:i,timestamp:Date.now(),redirectTimeMs:a,region:e.cf?.colo?String(e.cf.colo):void 0,version:"v1.0.0"})),Response.redirect(i,302)}s(v,"handleRedirect");var E={async fetch(e,t,n){let o=new URL(e.url).pathname;if(e.method==="OPTIONS")return L();if(e.method==="POST"&&o==="/api/shorten")return P(e,t);if(e.method==="GET"&&o.length>1){let i=o.slice(1);if(/^[A-Za-z0-9_-]+$/.test(i))return v(e,t,n,i)}return c(new Response(JSON.stringify({error:"Not found"}),{status:404,headers:{"Content-Type":"application/json"}}))}};var W=s(async(e,t,n,r)=>{try{return await r.next(e,t)}finally{try{if(e.body!==null&&!e.bodyUsed){let o=e.body.getReader();for(;!(await o.read()).done;);}}catch(o){console.error("Failed to drain the unused request body.",o)}}},"drainBody"),x=W;function C(e){return{name:e?.name,message:e?.message??String(e),stack:e?.stack,cause:e?.cause===void 0?void 0:C(e.cause)}}s(C,"reduceError");var k=s(async(e,t,n,r)=>{try{return await r.next(e,t)}catch(o){let i=C(o);return Response.json(i,{status:500,headers:{"MF-Experimental-Error-Stack":"true"}})}},"jsonError"),A=k;var d=[x,A],u=E;var T=[];function g(...e){T.push(...e.flat())}s(g,"__facade_register__");function S(e,t,n,r,o){let[i,...a]=o;return i(e,t,n,{dispatch:r,next(p,m){return S(p,m,n,r,a)}})}s(S,"__facade_invokeChain__");function y(e,t,n,r,o){return S(e,t,n,r,[...T,o])}s(y,"__facade_invoke__");var l=class{constructor(t,n,r){this.scheduledTime=t;this.cron=n;this.#e=r}#e;noRetry(){if(!(this instanceof l))throw new TypeError("Illegal invocation");this.#e()}};s(l,"__Facade_ScheduledController__");function J(e){if(d===void 0||d.length===0)return e;for(let n of d)g(n);let t=s(function(n,r,o){if(e.fetch===void 0)throw new Error("Handler does not export a fetch() function.");return e.fetch(n,r,o)},"fetchDispatcher");return{...e,fetch(n,r,o){return y(n,r,o,s(function(a,h){if(a==="scheduled"&&e.scheduled!==void 0){let p=new l(Date.now(),h.cron??"",()=>{});return e.scheduled(p,r,o)}},"dispatcher"),t)}}}s(J,"wrapExportedHandler");function q(e){if(d===void 0||d.length===0)return e;for(let t of d)g(t);return class extends e{#e=(t,n,r)=>{if(this.env=n,this.ctx=r,super.fetch===void 0)throw new Error("Entrypoint class does not define a fetch() function.");return super.fetch(t)};#t=(t,n)=>{if(t==="scheduled"&&super.scheduled!==void 0){let r=new l(Date.now(),n.cron??"",()=>{});return super.scheduled(r)}};fetch(t){return y(t,this.env,this.ctx,this.#t,this.#e)}}}s(q,"wrapWorkerEntrypoint");var R;typeof u=="object"?R=J(u):typeof u=="function"&&(R=q(u));var ye=R;export{d as __INTERNAL_WRANGLER_MIDDLEWARE__,ye as default};
//# sourceMappingURL=index.js.map
