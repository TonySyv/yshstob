var S=Object.defineProperty;var s=(e,t)=>S(e,"name",{value:t,configurable:!0});function U(e,t){let n=new Request(e,t);return n.headers.delete("CF-Connecting-IP"),n}s(U,"stripCfConnectingIPHeader");globalThis.fetch=new Proxy(globalThis.fetch,{apply(e,t,n){return Reflect.apply(e,t,[U.apply(null,n)])}});function D(e=8){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",n=new Uint8Array(e);crypto.getRandomValues(n);let r="";for(let o=0;o<e;o++)r+=t[n[o]%t.length];return r}s(D,"generateShortCode");function M(e){let t=e.trim();return t.match(/^https?:\/\//i)?t:`https://${t}`}s(M,"normalizeUrl");function b(e){try{let t=new URL(e);return t.protocol==="http:"||t.protocol==="https:"}catch{return!1}}s(b,"isValidUrl");var g={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type","Access-Control-Max-Age":"86400"};function I(){return new Response(null,{status:204,headers:g})}s(I,"handleCorsPreflight");function c(e){let t=new Response(e.body,e);return Object.entries(g).forEach(([n,r])=>{t.headers.set(n,r)}),t}s(c,"addCorsHeaders");async function L(e,t){let n=e.ANALYTICS_WORKER_URL;if(n)try{await fetch(`${n}/analytics/redirect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch{}}s(L,"sendAnalyticsEvent");async function N(e,t){try{let n=await e.json(),{longUrl:r}=n;if(!r||typeof r!="string")return c(new Response(JSON.stringify({error:"Missing or invalid longUrl"}),{status:400,headers:{"Content-Type":"application/json"}}));let o=M(r);if(!b(o))return c(new Response(JSON.stringify({error:"Invalid URL format"}),{status:400,headers:{"Content-Type":"application/json"}}));let i,a=0,u=10;do{if(i=D(),!await t.KV_URLS.get(i))break;a++}while(a<u);if(a>=u)return c(new Response(JSON.stringify({error:"Failed to generate unique code"}),{status:500,headers:{"Content-Type":"application/json"}}));await t.KV_URLS.put(i,o);let A={shortUrl:`${new URL(e.url).origin}/${i}`,longUrl:o};return c(new Response(JSON.stringify(A),{status:200,headers:{"Content-Type":"application/json"}}))}catch{return c(new Response(JSON.stringify({error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json"}}))}}s(N,"handleShorten");async function O(e,t,n,r){let o=Date.now(),i=await t.KV_URLS.get(r);if(!i)return c(new Response(JSON.stringify({error:"Short URL not found"}),{status:404,headers:{"Content-Type":"application/json"}}));let a=Date.now()-o;return n.waitUntil(L(t,{code:r,longUrl:i,timestamp:Date.now(),redirectTimeMs:a,region:e.cf?.colo?String(e.cf.colo):void 0,version:"v1.0.0"})),Response.redirect(i,302)}s(O,"handleRedirect");var w={async fetch(e,t,n){let o=new URL(e.url).pathname;if(e.method==="OPTIONS")return I();if(e.method==="POST"&&o==="/api/shorten")return N(e,t);if(e.method==="GET"&&o.length>1){let i=o.slice(1);if(/^[A-Za-z0-9_-]+$/.test(i))return O(e,t,n,i)}return c(new Response(JSON.stringify({error:"Not found"}),{status:404,headers:{"Content-Type":"application/json"}}))}};var v=s(async(e,t,n,r)=>{try{return await r.next(e,t)}finally{try{if(e.body!==null&&!e.bodyUsed){let o=e.body.getReader();for(;!(await o.read()).done;);}}catch(o){console.error("Failed to drain the unused request body.",o)}}},"drainBody"),_=v;function E(e){return{name:e?.name,message:e?.message??String(e),stack:e?.stack,cause:e?.cause===void 0?void 0:E(e.cause)}}s(E,"reduceError");var W=s(async(e,t,n,r)=>{try{return await r.next(e,t)}catch(o){let i=E(o);return Response.json(i,{status:500,headers:{"MF-Experimental-Error-Stack":"true"}})}},"jsonError"),x=W;var d=[_,x],p=w;var C=[];function h(...e){C.push(...e.flat())}s(h,"__facade_register__");function T(e,t,n,r,o){let[i,...a]=o;return i(e,t,n,{dispatch:r,next(f,R){return T(f,R,n,r,a)}})}s(T,"__facade_invokeChain__");function m(e,t,n,r,o){return T(e,t,n,r,[...C,o])}s(m,"__facade_invoke__");var l=class{constructor(t,n,r){this.scheduledTime=t;this.cron=n;this.#e=r}#e;noRetry(){if(!(this instanceof l))throw new TypeError("Illegal invocation");this.#e()}};s(l,"__Facade_ScheduledController__");function k(e){if(d===void 0||d.length===0)return e;for(let n of d)h(n);let t=s(function(n,r,o){if(e.fetch===void 0)throw new Error("Handler does not export a fetch() function.");return e.fetch(n,r,o)},"fetchDispatcher");return{...e,fetch(n,r,o){return m(n,r,o,s(function(a,u){if(a==="scheduled"&&e.scheduled!==void 0){let f=new l(Date.now(),u.cron??"",()=>{});return e.scheduled(f,r,o)}},"dispatcher"),t)}}}s(k,"wrapExportedHandler");function H(e){if(d===void 0||d.length===0)return e;for(let t of d)h(t);return class extends e{#e=(t,n,r)=>{if(this.env=n,this.ctx=r,super.fetch===void 0)throw new Error("Entrypoint class does not define a fetch() function.");return super.fetch(t)};#t=(t,n)=>{if(t==="scheduled"&&super.scheduled!==void 0){let r=new l(Date.now(),n.cron??"",()=>{});return super.scheduled(r)}};fetch(t){return m(t,this.env,this.ctx,this.#t,this.#e)}}}s(H,"wrapWorkerEntrypoint");var y;typeof p=="object"?y=k(p):typeof p=="function"&&(y=H(p));var me=y;export{d as __INTERNAL_WRANGLER_MIDDLEWARE__,me as default};
//# sourceMappingURL=index.js.map
