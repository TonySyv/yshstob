var P=Object.defineProperty;var o=(e,t)=>P(e,"name",{value:t,configurable:!0});function L(e,t){let r=new Request(e,t);return r.headers.delete("CF-Connecting-IP"),r}o(L,"stripCfConnectingIPHeader");globalThis.fetch=new Proxy(globalThis.fetch,{apply(e,t,r){return Reflect.apply(e,t,[L.apply(null,r)])}});var w="analytics:total_redirects",g="analytics:total_ms",E="analytics:version",R="analytics:deploy_timestamp",C="analytics:commit_summary",p={total_redirects:0,total_ms:0,version:"v1.000",deploy_timestamp:new Date().toISOString(),commit_summary:"Initial deployment"},A={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PATCH, OPTIONS","Access-Control-Allow-Headers":"Content-Type","Access-Control-Max-Age":"86400"};function O(){return new Response(null,{status:204,headers:A})}o(O,"handleCorsPreflight");function i(e){let t=new Response(e.body,e);return Object.entries(A).forEach(([r,n])=>{t.headers.set(r,n)}),t}o(i,"addCorsHeaders");async function T(e){let[t,r,n,s,d]=await Promise.all([e.KV_ANALYTICS.get(w),e.KV_ANALYTICS.get(g),e.KV_ANALYTICS.get(E),e.KV_ANALYTICS.get(R),e.KV_ANALYTICS.get(C)]);return{total_redirects:t?parseInt(t,10):p.total_redirects,total_ms:r?parseInt(r,10):p.total_ms,version:n||p.version,deploy_timestamp:s||p.deploy_timestamp,commit_summary:d||p.commit_summary}}o(T,"readCounters");async function x(e,t){let r=[];t.total_redirects!==void 0&&r.push(e.KV_ANALYTICS.put(w,t.total_redirects.toString())),t.total_ms!==void 0&&r.push(e.KV_ANALYTICS.put(g,t.total_ms.toString())),t.version!==void 0&&r.push(e.KV_ANALYTICS.put(E,t.version)),t.deploy_timestamp!==void 0&&r.push(e.KV_ANALYTICS.put(R,t.deploy_timestamp)),t.commit_summary!==void 0&&r.push(e.KV_ANALYTICS.put(C,t.commit_summary)),await Promise.all(r)}o(x,"writeCounters");function Y(e,t){return t===0?0:e/t}o(Y,"computeAverage");async function K(e,t){try{let r=await e.json();if(!r.code||!r.longUrl||!r.timestamp)return i(new Response(JSON.stringify({error:"Invalid event data"}),{status:400,headers:{"Content-Type":"application/json"}}));let n=await T(t),s=r.redirectTimeMs||0;return await x(t,{total_redirects:n.total_redirects+1,total_ms:n.total_ms+s}),i(new Response(JSON.stringify({success:!0}),{status:200,headers:{"Content-Type":"application/json"}}))}catch{return i(new Response(JSON.stringify({error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json"}}))}}o(K,"handleAnalyticsRedirect");async function j(e){try{let t=await T(e),r=Y(t.total_ms,t.total_redirects),n={version:t.version,deploy_timestamp:t.deploy_timestamp,commit_summary:t.commit_summary,total_redirects:t.total_redirects,average_redirect_ms:Math.round(r*1e3)/1e3};return i(new Response(JSON.stringify(n),{status:200,headers:{"Content-Type":"application/json"}}))}catch{return i(new Response(JSON.stringify({error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json"}}))}}o(j,"handleSpeedometer");async function H(e,t){try{let r=await e.json();return!r.version||!r.deploy_timestamp?i(new Response(JSON.stringify({error:"Missing required fields: version, deploy_timestamp"}),{status:400,headers:{"Content-Type":"application/json"}})):(await x(t,{version:r.version,deploy_timestamp:r.deploy_timestamp,commit_summary:r.commit_summary||"No commit message"}),i(new Response(JSON.stringify({success:!0}),{status:200,headers:{"Content-Type":"application/json"}})))}catch{return i(new Response(JSON.stringify({error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json"}}))}}o(H,"handleDeployMetadata");var I={async fetch(e,t,r){let s=new URL(e.url).pathname;return e.method==="OPTIONS"?O():e.method==="POST"&&s==="/analytics/redirect"?K(e,t):e.method==="GET"&&s==="/speedometer"?j(t):e.method==="PATCH"&&s==="/metadata/deploy"?H(e,t):i(new Response(JSON.stringify({error:"Not found"}),{status:404,headers:{"Content-Type":"application/json"}}))}};var W=o(async(e,t,r,n)=>{try{return await n.next(e,t)}finally{try{if(e.body!==null&&!e.bodyUsed){let s=e.body.getReader();for(;!(await s.read()).done;);}}catch(s){console.error("Failed to drain the unused request body.",s)}}},"drainBody"),S=W;function M(e){return{name:e?.name,message:e?.message??String(e),stack:e?.stack,cause:e?.cause===void 0?void 0:M(e.cause)}}o(M,"reduceError");var V=o(async(e,t,r,n)=>{try{return await n.next(e,t)}catch(s){let d=M(s);return Response.json(d,{status:500,headers:{"MF-Experimental-Error-Stack":"true"}})}},"jsonError"),v=V;var a=[S,v],l=I;var N=[];function f(...e){N.push(...e.flat())}o(f,"__facade_register__");function D(e,t,r,n,s){let[d,...m]=s;return d(e,t,r,{dispatch:n,next(u,b){return D(u,b,r,n,m)}})}o(D,"__facade_invokeChain__");function _(e,t,r,n,s){return D(e,t,r,n,[...N,s])}o(_,"__facade_invoke__");var c=class{constructor(t,r,n){this.scheduledTime=t;this.cron=r;this.#e=n}#e;noRetry(){if(!(this instanceof c))throw new TypeError("Illegal invocation");this.#e()}};o(c,"__Facade_ScheduledController__");function q(e){if(a===void 0||a.length===0)return e;for(let r of a)f(r);let t=o(function(r,n,s){if(e.fetch===void 0)throw new Error("Handler does not export a fetch() function.");return e.fetch(r,n,s)},"fetchDispatcher");return{...e,fetch(r,n,s){return _(r,n,s,o(function(m,h){if(m==="scheduled"&&e.scheduled!==void 0){let u=new c(Date.now(),h.cron??"",()=>{});return e.scheduled(u,n,s)}},"dispatcher"),t)}}}o(q,"wrapExportedHandler");function U(e){if(a===void 0||a.length===0)return e;for(let t of a)f(t);return class extends e{#e=(t,r,n)=>{if(this.env=r,this.ctx=n,super.fetch===void 0)throw new Error("Entrypoint class does not define a fetch() function.");return super.fetch(t)};#t=(t,r)=>{if(t==="scheduled"&&super.scheduled!==void 0){let n=new c(Date.now(),r.cron??"",()=>{});return super.scheduled(n)}};fetch(t){return _(t,this.env,this.ctx,this.#t,this.#e)}}}o(U,"wrapWorkerEntrypoint");var y;typeof l=="object"?y=q(l):typeof l=="function"&&(y=U(l));var ge=y;export{a as __INTERNAL_WRANGLER_MIDDLEWARE__,ge as default};
//# sourceMappingURL=index.js.map
